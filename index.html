<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Typing Master</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Inter", sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #0a0a0a, #1a1a1a);
  color: #d4d4d4;
  padding: 20px;
}
.container {
  background: rgba(40,40,40,0.8);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  padding: 30px;
  width: 100%;
  max-width: 900px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  animation: fadeIn 0.5s ease;
}
@keyframes fadeIn { from {opacity:0; transform:scale(.98)} to {opacity:1; transform:scale(1)} }
h1 {
  text-align: center;
  font-size: 2.2rem;
  font-weight: 600;
  background: linear-gradient(90deg,#88c0d0,#81a1c1);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  margin: 0;
}
.welcome-banner {
  background: rgba(136,192,208,0.1);
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 0.95rem;
  text-align: center;
  color:#88c0d0;
}
#textDisplay {
  background: rgba(33,33,33,0.7);
  padding: 18px;
  border-radius: 10px;
  min-height: 150px;
  font-family: "Roboto Mono", monospace;
  line-height: 1.7;
  font-size: 1.1rem;
  transition: background .18s ease;
}
.correct { color:#a3be8c; }
.incorrect { color:#bf616a; background-color: rgba(191,97,106,0.12); }
.current-char { background-color:#ebcb8b; color:#212121; padding:0 2px; border-radius:3px; }

#userInput {
  width:100%;
  height:120px;
  font-size:1rem;
  padding:12px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.05);
  background: rgba(33,33,33,0.8);
  color:#fff;
  resize:none;
  font-family:"Roboto Mono", monospace;
}

.controls {
  display:flex;
  flex-wrap:wrap;
  gap:15px;
  justify-content:space-between;
  align-items:flex-end;
}
.metrics {
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:0.95rem;
  text-align:left; /* left aligned as requested */
}
.metrics div {
  background: rgba(255,255,255,0.05);
  padding:6px 10px;
  border-radius:6px;
}
button {
  background: linear-gradient(90deg,#5e81ac,#81a1c1);
  border:none;
  padding:10px 20px;
  border-radius:8px;
  color:#fff;
  cursor:pointer;
  font-weight:500;
  transition: transform .12s ease, opacity .12s ease;
}
button:hover { opacity:.95; transform:translateY(-2px); }

#timePeriodDropdown {
  background: rgba(33,33,33,0.8);
  color:#fff;
  border:1px solid rgba(255,255,255,0.05);
  border-radius:6px;
  padding:6px 10px;
  font-size:0.9rem;
  max-width:120px;
}
#timePeriodDropdown:focus { outline:none; border-color:#5e81ac; }

.custom-text-option { display:flex; align-items:center; gap:8px; font-size:0.9rem; }
.custom-text-area-wrapper { display:none; margin-top:8px; }
.custom-text-area-wrapper.active { display:block; }
#customParagraphInput {
  width:100%;
  min-height:120px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.05);
  background: rgba(33,33,33,0.8);
  color:#fff;
  font-family:"Roboto Mono", monospace;
  padding:10px;
}

.fancy-name { font-size:10px; color:#88c0d0; text-align:center; margin-top:12px; }

/* popup */
#endScreen {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.78);
  align-items:center; justify-content:center;
  z-index:9999;
  opacity:0;
  transition:opacity .36s ease;
}
#endScreen.show { display:flex; opacity:1; }
#endScreenContent {
  background:#111;
  border-radius:14px;
  padding:22px 28px;
  max-width:420px;
  width:90%;
  color:#fff;
  box-shadow:0 10px 40px rgba(0,0,0,0.6);
  transform: translateY(6px) scale(.98);
  transition: transform .28s ease, opacity .28s ease;
}
#endScreen.show #endScreenContent { transform: translateY(0) scale(1); }
#endScreenContent h2 { margin-top:0; margin-bottom:8px; }
#endScreenContent p { margin:6px 0; }
@media (max-width:600px) { .controls { flex-direction:column; } button { width:100%; } }
</style>
</head>
<body>
  <div class="container">
    <h1>Typing Master</h1>
    <div class="welcome-banner">üí° Start typing to begin. Press Enter to finish. Close the results to start again.</div>

    <div id="textDisplay"></div>
    <textarea id="userInput" placeholder="Start typing here..." disabled></textarea>

    <div class="controls">
      <select id="timePeriodDropdown" aria-label="Test duration">
        <option value="120">2 Min</option>
        <option value="300" selected>5 Min</option>
        <option value="600">10 Min</option>
        <option value="0">Free Mode</option>
      </select>

      <div class="metrics">
  <div id="timer">Time: 00:00</div>
  <div id="accuracy">Accuracy: 100.00%</div>
  <div id="wpm">WPM: 0</div>
  <div id="progress">Progress: 0%</div>
      </div>

      <div>
        <button id="startButton">Start Test</button>
        <button id="finishButton" style="display:none;">Finish Test</button>
        <button id="resetButton">Reset Test</button>
      </div>
    </div>

    <div class="custom-text-option">
      <input type="checkbox" id="useCustomTextCheckbox" />
  <label for="useCustomTextCheckbox" style="font-size:0.7rem;">Use Custom Text</label>
    </div>

    <div class="custom-text-area-wrapper" id="customTextAreaWrapper">
      <textarea id="customParagraphInput" placeholder="Type or paste your custom paragraph here."></textarea>
    </div>

    <div id="endScreen" role="dialog" aria-modal="true" aria-hidden="true">
      <div id="endScreenContent">
        <h2>Test Results</h2>
        <p id="resultWPM"></p>
        <p id="resultAccuracy"></p>
        <p id="resultTime"></p>
        <div style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
          <button id="closeResultsBtn" style="padding:8px 14px;">Close</button>
        </div>
      </div>
    </div>

  <div class="fancy-name" style="color:#c1e5f5;">Made by Aditya ‚ù§</div>
  </div>

<script>
/* === Elements === */
const textDisplay = document.getElementById('textDisplay');
const userInput = document.getElementById('userInput');
const timerElement = document.getElementById('timer');
const accuracyElement = document.getElementById('accuracy');
const wpmElement = document.getElementById('wpm');
const progressElement = document.getElementById('progress');
const startButton = document.getElementById('startButton');
const finishButton = document.getElementById('finishButton');
const resetButton = document.getElementById('resetButton');
const timePeriodDropdown = document.getElementById('timePeriodDropdown');
const useCustomTextCheckbox = document.getElementById('useCustomTextCheckbox');
const customTextAreaWrapper = document.getElementById('customTextAreaWrapper');
const customParagraphInput = document.getElementById('customParagraphInput');
const endScreen = document.getElementById('endScreen');
const closeResultsBtn = document.getElementById('closeResultsBtn');

/* === Data === */

// Original paragraph (keep as one of the options)
const originalParagraph = "life is a journey filled with ups and downs and every person walks a path that is unique to them sometimes the road is smooth and easy and everything feels like it is going your way but other times challenges appear and you have to gather your strength to keep moving forward even when you feel tired or uncertain there are moments when you might feel like giving up but those are the times when it is most important to keep going because every step you take no matter how small brings you closer to where you want to be learning from your mistakes growing from your experiences and staying true to your purpose are the things that help you become stronger over time the people you meet the lessons you learn and the choices you make all shape your story and your story is something that no one else can write for you each day gives you a chance to start fresh to try again and to move with a little more hope and confidence than the day before do not worry if progress feels slow because even small improvements add up and with patience and effort you will reach your goals always remember that you have the power to change your future by the actions you take today so keep going keep learning and never stop believing in yourself because you are capable of more than you think and the world is waiting to see all the amazing things you can do";

// Additional well-punctuated paragraphs (200-250 words each)
const typingParagraphs = [
  originalParagraph,
  "Technology has transformed the way we live, work, and communicate. In the past, people relied on letters and landline phones to stay in touch, but now, instant messaging and video calls connect us across continents in seconds. The rise of smartphones and the internet has made information accessible to everyone, allowing us to learn new skills, explore different cultures, and stay updated with global events. However, with these advancements come new challenges, such as maintaining privacy and managing screen time. It is important to find a balance between embracing innovation and preserving our well-being. By using technology mindfully, we can enhance productivity, foster creativity, and build meaningful relationships. As we move forward, we must remember that technology is a tool, not a replacement for genuine human connection. Taking breaks, spending time outdoors, and engaging in face-to-face conversations are essential for a healthy lifestyle. Ultimately, the choices we make in our digital lives shape our experiences and influence the world around us. By staying informed, being responsible, and prioritizing what truly matters, we can harness the power of technology to create a brighter future for ourselves and generations to come.",
  "The beauty of nature is all around us, from the gentle rustling of leaves in the wind to the vibrant colors of a sunset. Every season brings its own wonders: spring awakens the earth with blooming flowers, summer fills the air with warmth and laughter, autumn paints the trees in shades of gold and red, and winter wraps the world in a quiet, frosty embrace. Spending time outdoors can refresh the mind and lift the spirit, whether you are hiking through forests, strolling in a park, or simply sitting beneath a tree. Observing birds, listening to the sound of rain, and feeling the sun on your face are simple pleasures that remind us of the world‚Äôs natural rhythms. Protecting the environment is a shared responsibility, and small actions like recycling, conserving water, and planting trees can make a big difference. By appreciating and caring for nature, we ensure that its beauty endures for future generations. Let us take time to notice the details, cherish the moments, and respect the planet that sustains us all.",
  "Reading is a gateway to new worlds, ideas, and perspectives. Whether you prefer novels, biographies, or articles, each page offers an opportunity to learn, imagine, and grow. Books can transport you to distant lands, introduce you to fascinating characters, and challenge your understanding of life. Developing a reading habit not only improves vocabulary and comprehension but also fosters empathy and critical thinking. In a fast-paced world, setting aside time for reading can be a peaceful escape from daily stress. Libraries and bookstores are treasure troves of knowledge, waiting to be explored. Sharing books with friends, joining a book club, or writing about what you read can deepen your appreciation and spark meaningful conversations. No matter your age or interests, there is always something new to discover in the world of literature. So, open a book, turn the pages, and let your imagination soar. The stories you encounter may inspire you, comfort you, or even change the way you see the world.",
  "A strong morning routine can set the tone for the entire day. Many successful people emphasize the value of starting their day with discipline and positive habits. Waking up early allows the mind to stay calm and focused, while the quiet atmosphere creates space for reflection and planning. Some individuals prefer light exercise such as yoga, stretching, or a short walk, which helps increase energy levels and improve circulation. Others dedicate time to reading or journaling, allowing their thoughts to flow clearly and setting personal goals. Breakfast also plays a key role in fueling the body. A nutritious meal rich in protein, whole grains, and fruits provides lasting energy and supports concentration. Avoiding distractions, like unnecessary social media scrolling, can prevent wasted time and promote productivity. Even simple habits, such as making your bed, can create a sense of accomplishment and encourage discipline throughout the day. Consistency is the most important factor. A morning routine does not need to be long or complicated; it simply needs to be followed regularly. By investing in these small actions each morning, people can build momentum, reduce stress, and approach their tasks with confidence and clarity.",
  "One morning my friend and I were thinking about how we could plan our summer break away from school. Driving from our own state to several nearby states would help to expand our limited funds. Inviting six other friends to accompany us would lower our car expenses. Stopping at certain sites would also help us stretch our truly limited travel budget. Yesterday I engaged in an interesting and enlightening discussion about finances. I found it difficult to imagine that during my lifetime I might well earn at least one-half million dollars. It is also possible that I might spend as much as one-half million during the same period. The really difficult thing for me to do will be to save more of the half-million than I spend. Thinking about today's high cost of living makes this seem an impossible task for most. Last week I asked a friend to talk with me and a girl-friend about college. Our friend is the Dean of Women at a nearby college. The Dean and her staff spend much of their time talking to students who plan to go to college. The first thing she said was to work very hard each day in high school. Good grades are most important for being accepted. Being on time for classes and having a good view toward all phases of the school life are two other things to remember.",
  "Technology has changed the way we live our lives in countless ways. From the moment we wake up to the time we go to sleep, we are surrounded by devices and systems that make our daily routines easier and more efficient. Smartphones allow us to connect with friends and family no matter where they are in the world. Computers help us work, learn, and create with tools that were unimaginable just a few decades ago. The internet provides access to information, entertainment, and opportunities that can enrich our lives and broaden our horizons. But with all these advancements comes the responsibility to use technology wisely and thoughtfully. It is important to balance screen time with real-world experiences, and to remember that the most meaningful connections are often made face to face. By staying curious and open-minded, we can continue to adapt to new innovations and make the most of the resources available to us.",
  "The natural world is full of wonders that inspire awe and curiosity. From the tallest mountains to the deepest oceans, every part of our planet has its own unique beauty and mystery. Spending time outdoors can help us feel more connected to the earth and remind us of the importance of protecting the environment. Walking through a forest, listening to the sound of birds, or watching the waves crash on the shore can bring a sense of peace and clarity that is hard to find elsewhere. Nature teaches us about cycles of growth, change, and renewal, and encourages us to appreciate the simple things in life. By taking care of our surroundings and making choices that support sustainability, we can ensure that future generations will also have the chance to experience the magic of the natural world.",
  "Healthy habits are the foundation of a happy and productive life. Eating nutritious foods, getting regular exercise, and making time for rest are all important for maintaining physical and mental well-being. Small changes like drinking more water, taking short walks, or practicing mindfulness can have a big impact over time. It is also important to set realistic goals and celebrate your progress along the way. Remember that self-care is not selfish, but necessary for being your best self. By prioritizing your health and making positive choices, you can create a routine that supports your long-term success and happiness.",
  "Learning a new skill can be both challenging and rewarding. Whether you are picking up a musical instrument, mastering a language, or trying out a new sport, the process of learning helps you grow and discover your strengths. It is normal to make mistakes and feel frustrated at times, but persistence and practice are key to improvement. Setting aside time each day to work on your skill and seeking feedback from others can help you stay motivated and track your progress over time. The sense of accomplishment you feel when you reach a milestone or overcome a difficult obstacle is worth the effort and can inspire you to keep pushing your limits.",
  "Friendship is one of the most valuable parts of life. True friends support you through good times and bad, and help you become a better person. By sharing experiences and listening to each other, you build trust and understanding that can last a lifetime. It is important to nurture your friendships by being honest, kind, and dependable. Even when life gets busy, making time for the people who matter most can strengthen your bonds and create memories that you will cherish for years to come.",
  "Traveling to new places can open your eyes to different cultures and ways of life. Exploring unfamiliar cities, tasting new foods, and meeting people from around the world can broaden your perspective and help you appreciate the diversity of human experience. Travel also teaches you to be adaptable and resourceful as you navigate new environments and overcome challenges. Whether you are planning a big adventure or simply visiting a nearby town, every journey offers opportunities for growth and discovery.",
  "Music has the power to move us in ways that words alone cannot. A beautiful melody or a powerful rhythm can lift our spirits and bring people together across languages and backgrounds. Playing an instrument, singing, or simply listening to your favorite songs can be a source of comfort and inspiration. Music can help us express our emotions, celebrate special moments, and find meaning in everyday life. By exploring different genres and artists, you can discover new sounds and enrich your appreciation for the art of music.",
  "Setting goals is an important part of achieving success in any area of life. Whether you are working toward a career milestone, improving your health, or learning something new, having clear objectives can help you stay focused and motivated. Break your goals into smaller steps and celebrate your progress along the way. Remember that setbacks are a natural part of the journey and can teach you valuable lessons about perseverance and resilience. By staying committed and believing in yourself, you can turn your dreams into reality."
];


let paragraphLines = [];
let currentLineIndex = 0;
const linesToShow = 3;
let currentParagraphText = '';
let startTime = 0;
let timerInterval = null;
let running = false;
let totalErrors = 0, totalTypedCharacters = 0, totalCorrectCharacters = 0;
let popupOpen = false;
let maxTime = 0; // seconds (0 = free mode)
let selectedParagraph = originalParagraph;

/* === Helpers === */
const formatTime = sec => `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;

const splitParagraphIntoLines = (text, charsPerLine = 70) => {
  if (!text || !text.trim()) return ["Start typing in the custom text area to begin practice!"];
  const words = text.split(/\s+/);
  let lines = [], line = '';
  words.forEach(word => {
    if ((line + word).length + 1 > charsPerLine) {
      lines.push(line.trim());
      line = word + ' ';
    } else line += word + ' ';
  });
  if (line) lines.push(line.trim());
  return lines;
};

const formatTextSegmentForDisplay = text => text.split('').map(c => `<span>${c}</span>`).join('');

const updateDisplayLines = () => {
  currentParagraphText = paragraphLines.slice(currentLineIndex, currentLineIndex + linesToShow).join(' ');
  textDisplay.innerHTML = formatTextSegmentForDisplay(currentParagraphText);
  applyTypingFeedback(userInput.value);
};

const calculateFeedback = (typed, target) => {
  let correct = 0, incorrect = 0;
  for (let i = 0; i < Math.min(typed.length, target.length); i++) {
    if (typed[i] === target[i]) correct++;
    else incorrect++;
  }
  if (typed.length > target.length) incorrect += typed.length - target.length;
  return { correct, incorrect, typed: typed.length };
};

const updateMetrics = (elapsed, input) => {
  const f = calculateFeedback(input, currentParagraphText);
  const liveCorrect = totalCorrectCharacters + f.correct;
  const liveTyped = totalTypedCharacters + f.typed;
  const acc = liveTyped ? (liveCorrect / liveTyped) * 100 : 100;
  accuracyElement.textContent = `Accuracy: ${acc.toFixed(2)}%`;
  const wpm = elapsed ? Math.round((liveCorrect / 5) / (elapsed / 60)) : 0;
  wpmElement.textContent = `WPM: ${wpm}`;

  // Progress percentage calculation
  let totalChars = 0;
  let typedChars = 0;
  // Count total characters in the paragraph for the test
  if (paragraphLines && paragraphLines.length > 0) {
    totalChars = paragraphLines.join(' ').length;
    // Count all typed characters so far (including previous lines)
    typedChars = totalCorrectCharacters + totalTypedCharacters + input.length;
    // Clamp to totalChars
    if (typedChars > totalChars) typedChars = totalChars;
  }
  const progress = totalChars > 0 ? (typedChars / totalChars) * 100 : 0;
  progressElement.textContent = `Progress: ${progress.toFixed(1)}%`;
};

const applyTypingFeedback = input => {
  const spans = textDisplay.querySelectorAll('span');
  spans.forEach((span,i) => {
    span.classList.remove('correct','incorrect','current-char');
    if (i < input.length) span.classList.add(input[i] === currentParagraphText[i] ? 'correct' : 'incorrect');
    else if (i === input.length) span.classList.add('current-char');
  });
};

/* === Timer / test flow === */
const startTimer = () => {
  if (running) return;
  running = true;
  startTime = Date.now();
  timerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    timerElement.textContent = `Time: ${formatTime(elapsed)}`;
    updateMetrics(elapsed, userInput.value);

    // check maxTime and finish if reached
    if (maxTime > 0 && elapsed >= maxTime) {
      finishTest();
    }
  }, 1000);
};

const stopTimer = () => { clearInterval(timerInterval); timerInterval = null; running = false; };

/* Move to next line even if typed wrong (length based) */
const checkLineCompletion = () => {
  if (userInput.value.length >= currentParagraphText.length) {
    const f = calculateFeedback(userInput.value, currentParagraphText);
    totalCorrectCharacters += f.correct;
    totalErrors += f.incorrect;
    totalTypedCharacters += f.typed;
    currentLineIndex += linesToShow;
    userInput.value = '';
    if (currentLineIndex < paragraphLines.length) updateDisplayLines();
    else finishTest();
  }
};

const finishTest = () => {
  // avoid repeated finish calls
  if (popupOpen) return;
  stopTimer();
  running = false;
  popupOpen = true;

  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  updateMetrics(elapsed, userInput.value);
    progressElement.textContent = "Progress: 0%"; // Reset progress immediately

  document.getElementById('resultWPM').textContent = wpmElement.textContent;
  document.getElementById('resultAccuracy').textContent = accuracyElement.textContent;
  document.getElementById('resultTime').textContent = 'Time: ' + formatTime(elapsed);

  // Immediately reset test state (clears typing area etc.) but keep popup visible
  resetTest(true);
  endScreen.classList.add('show');
  endScreen.setAttribute('aria-hidden','false');
};


const resetTest = (keepPopup=false) => {
  stopTimer();
  userInput.value = '';
  userInput.disabled = true;
  timerElement.textContent = "Time: 00:00";
  accuracyElement.textContent = "Accuracy: 100.00%";
  wpmElement.textContent = "WPM: 0";
    progressElement.textContent = "Progress: 0%"; // Reset progress immediately
  totalErrors = totalTypedCharacters = totalCorrectCharacters = 0;
  currentLineIndex = 0;

  // Hide custom paragraph tray on reset, but do not uncheck the checkbox
  customTextAreaWrapper.style.display = 'none';
  customTextAreaWrapper.classList.remove('active');

  // If custom text is checked, use it; otherwise, randomly select a paragraph
  if (useCustomTextCheckbox.checked) {
    selectedParagraph = customParagraphInput.value.trim();
  } else {
    // Randomly select a paragraph from the array
    selectedParagraph = typingParagraphs[Math.floor(Math.random() * typingParagraphs.length)];
  }
  paragraphLines = splitParagraphIntoLines(selectedParagraph);

  // pad short paragraphs so they don't immediately finish
  while (paragraphLines.length < 3) paragraphLines.push(" ");

  updateDisplayLines();

  startButton.style.display = 'inline-block';
  finishButton.style.display = 'none';

  if (!keepPopup) {
    popupOpen = false;
    endScreen.classList.remove('show');
    endScreen.setAttribute('aria-hidden','true');
  }
};

/* Start test (programmatic or via start button) */
const startTest = () => {
  // don't start if popup is open
  if (popupOpen) return;
  userInput.disabled = false;
  userInput.focus();
  startButton.style.display = 'none';
  finishButton.style.display = 'inline-block';

  // Use selectedParagraph (already set by resetTest)
  paragraphLines = splitParagraphIntoLines(selectedParagraph);
  while (paragraphLines.length < 3) paragraphLines.push(" ");
  currentLineIndex = 0;
  totalErrors = totalTypedCharacters = totalCorrectCharacters = 0;
  updateDisplayLines();
  startTimer();
};

/* === Listeners === */

// dropdown -> update maxTime immediately
timePeriodDropdown.addEventListener('change', () => {
  maxTime = parseInt(timePeriodDropdown.value, 10) || 0;
});

// custom text checkbox -> toggle textarea visibility, reset state
useCustomTextCheckbox.addEventListener('change', () => {
  customTextAreaWrapper.classList.toggle('active', useCustomTextCheckbox.checked);
  customTextAreaWrapper.style.display = useCustomTextCheckbox.checked ? 'block' : 'none';
});

// buttons
startButton.addEventListener('click', startTest);
finishButton.addEventListener('click', finishTest);
resetButton.addEventListener('click', () => resetTest());
closeResultsBtn.addEventListener('click', () => {
  endScreen.classList.remove('show');
  endScreen.setAttribute('aria-hidden','true');
  popupOpen = false;
});

// typing area input
userInput.addEventListener('input', e => {
  if (!running && e.target.value.length > 0) startTimer();
  updateMetrics(Math.floor((Date.now() - startTime)/1000), e.target.value);
  applyTypingFeedback(e.target.value);
  checkLineCompletion();
});

// global key handling: start on any alnum key unless popup open or custom textarea has focus
document.addEventListener('keydown', e => {
  if (popupOpen) {
    if (e.key === 'Enter') {
      endScreen.classList.remove('show');
      endScreen.setAttribute('aria-hidden','true');
      popupOpen = false;
    }
    return;
  }
  // if user is typing in custom paragraph textarea, don't auto-start
  if (document.activeElement === customParagraphInput) return;

  if (!running && /^[a-zA-Z0-9]$/.test(e.key)) {
    startTest();
    // insert first key into userInput
    userInput.value += e.key;
    applyTypingFeedback(userInput.value);
    updateMetrics(Math.floor((Date.now()-startTime)/1000), userInput.value);
    e.preventDefault();
  } else if (e.key === 'Enter' && running) {
    finishTest();
  }
});

// initial setup
window.addEventListener('load', () => {
  maxTime = parseInt(timePeriodDropdown.value, 10) || 0;
  // On load, randomly select a paragraph
  selectedParagraph = typingParagraphs[Math.floor(Math.random() * typingParagraphs.length)];
  paragraphLines = splitParagraphIntoLines(selectedParagraph);
  // pad if short
  while (paragraphLines.length < 3) paragraphLines.push(" ");
  updateDisplayLines();
  resetTest(); // ensure input disabled on load
});
</script>
</body>
</html>
